<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puzzlewall</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <h1>Puzzlewall</h1>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="darkModeToggle">
                <input type="checkbox" id="darkModeToggle">
                <div class="slider round"></div>
            </label>
        </div>
    </header>

    <div class="container">
        <h4>Solve the following puzzle:</h4>
        <div class="gamecontainer">
            <div class="grid" id="grid">
                <div class="grid-item" onclick="selectItem(1)"></div>
                <div class="grid-item" onclick="selectItem(2)"></div>
                <div class="grid-item" onclick="selectItem(3)"></div>
                <div class="grid-item" onclick="selectItem(4)"></div>
                <div class="grid-item" onclick="selectItem(5)"></div>
                <div class="grid-item" onclick="selectItem(6)"></div>
                <div class="grid-item" onclick="selectItem(7)"></div>
                <div class="grid-item" onclick="selectItem(8)"></div>
                <div class="grid-item" onclick="selectItem(9)"></div>
            </div>
        </div>
        <div id="message" class="message"></div>
        <div id="input-section" class="hidden">
            <input type="text" class="name" id="name" placeholder="your name">
            <button class="button" id="submit-button" onclick="submitScore()">Submit Score</button>
        </div>
        <div id="continue-section" class="hidden">
            <button class="button" onclick="continueToContent()">Weiter zum Inhalt</button>
        </div>
    </div>
    <div id="current-leaderboard" class="leaderboard-container">
        <h3 id="leaderboard-title">Leaderboard</h3>
        <ul id="leaderboard-list" class="leaderboard-list"></ul>
    </div>
    <div id="other-leaderboard" class="leaderboard-container">
        <h3 id="other-leaderboard-title">Leaderboard</h3>
        <ul id="other-leaderboard-list" class="leaderboard-list"></ul>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let correctSequence = [];
        let userSequence = [];
        let puzzleSolved = false;
        let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        let startTime;
        let timerStarted = false;

        const socket = io();

        socket.on('update-leaderboard', () => {
            showLeaderboards();
        });

        socket.on('start-puzzle', (sequence) => {
            correctSequence = sequence;
        });

        function startPuzzle() {
            socket.emit('start-puzzle');
        }

        async function selectItem(number) {
            if (puzzleSolved) return;
            if (!timerStarted) {
                startPuzzle();
                timerStarted = true;
            }

            const gridItem = document.querySelector(`.grid-item:nth-child(${number})`);
            const hashedNumber = await hashNum(number.toString());

            if (correctSequence[userSequence.length] === hashedNumber) {
                gridItem.classList.add('correct');
                userSequence.push(number);
                if (userSequence.length === correctSequence.length) {
                    puzzleSolved = true;
                    socket.emit('end-puzzle', userSequence);
                }
            } else {
                gridItem.classList.add('incorrect');
                setTimeout(() => {
                    document.getElementById('message').innerText = "Falsche Reihenfolge. Bitte versuchen Sie es erneut.";
                    resetPuzzle();
                }, 80);
            }
        }

        function resetPuzzle() {
            userSequence = [];
            const gridItems = document.querySelectorAll('.grid-item');
            gridItems.forEach(item => {
                item.classList.remove('correct', 'incorrect');
            });
            puzzleSolved = false;
        }

        socket.on('puzzle-solved', (timeTaken) => {
            document.getElementById('input-section').classList.remove('hidden');
            document.getElementById('message').innerText = `Geschafft! Zeit: ${timeTaken} Sekunden. Geben Sie Ihren Namen ein.`;
        });

        function submitScore() {
            const name = document.getElementById('name').value;
            if (!name) {
                document.getElementById('message').innerText = "Bitte geben Sie Ihren Namen ein.";
                return;
            }

            socket.emit('submit-score', { name, isMobile });
        }

        socket.on('score-submitted', (message) => {
            document.getElementById('message').innerText = message;
            document.getElementById('continue-section').classList.remove('hidden');
            document.getElementById('input-section').style.display = 'none'; 
        });

        function showLeaderboards() {
            fetch(`/leaderboard?isMobile=${isMobile}`)
                .then(response => response.json())
                .then(data => {
                    const leaderboardList = document.getElementById('leaderboard-list');
                    const leaderboardTitle = document.getElementById('leaderboard-title');
                    leaderboardTitle.textContent = isMobile ? "Mobile Leaderboard" : "Desktop Leaderboard";
                    leaderboardList.innerHTML = '';
                    data.forEach((entry, index) => {
                        const listItem = document.createElement('li');
                        listItem.textContent = `${index + 1}. ${entry.name}: ${entry.time} Sekunden`;
                        leaderboardList.appendChild(listItem);
                    });
                });

            fetch(`/leaderboard?isMobile=${!isMobile}`)
                .then(response => response.json())
                .then(data => {
                    const otherLeaderboardList = document.getElementById('other-leaderboard-list');
                    const otherLeaderboardTitle = document.getElementById('other-leaderboard-title');
                    otherLeaderboardTitle.textContent = !isMobile ? "Mobile Leaderboard" : "Desktop Leaderboard";
                    otherLeaderboardList.innerHTML = '';
                    data.forEach((entry, index) => {
                        const listItem = document.createElement('li');
                        listItem.textContent = `${index + 1}. ${entry.name}: ${entry.time} Sekunden`;
                        otherLeaderboardList.appendChild(listItem);
                    });
                });
        }

        function continueToContent() {
            window.location.href = "content.html";
        }

        window.onload = function() {
            showLeaderboards();
        };

        async function hashNum(input) {
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        document.addEventListener("DOMContentLoaded", () => {
            const toggleButton = document.getElementById('darkModeToggle');

            if (localStorage.getItem("darkMode") === "enabled") {
                toggleButton.checked = true;
                enableDarkMode();
            }

            toggleButton.addEventListener("change", () => {
                if (toggleButton.checked) {
                    enableDarkMode();
                } else {
                    disableDarkMode();
                }
            });

            function enableDarkMode() {
                document.body.classList.add("dark-mode");
                document.querySelectorAll('.container, .leaderboard-container, .button, .grid-item').forEach(el => {
                    el.classList.add('dark-mode');
                });
                localStorage.setItem("darkMode", "enabled");
            }

            function disableDarkMode() {
                document.body.classList.remove("dark-mode");
                document.querySelectorAll('.container, .leaderboard-container, .button, .grid-item').forEach(el => {
                    el.classList.remove('dark-mode');
                });
                localStorage.setItem("darkMode", "disabled");
            }
        });
    </script>
</body>
</html>